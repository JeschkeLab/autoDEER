<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>autodeer.DEER_analysis - </title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-toolbox-code.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand"> </div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/autoDEER_EPR_light.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../_static/autoDEER_EPR_dark.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text"> </span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../source/Install.html">Installation</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Installation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../source/Install_python.html">Installing Python</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../source/tutorial.html">Tutorial</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Tutorial</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../source/Algorithum.html">The Automated Algorithum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../source/gui_guide.html">autoDEER GUI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../source/Jupyter_interface.html">Jupyter Interface</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../source/API_docs.html">API doc</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../source/autoEPR/index.html">autoEPR</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of autoEPR</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../source/autoEPR/Getting_Started.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../source/autoEPR/Sequencer.html">Creating a Custom Sequence</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../source/autoEPR/Interface.html">Interfaces</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Interfaces</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../source/autoEPR/Bruker_interface.html">Bruker Interface</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../source/releasenotes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/contributing.html">Contributing Guide</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/JeschkeLab/autoDEER">Github</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for autodeer.DEER_analysis</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span> <span class="nn">deerlab</span> <span class="k">as</span> <span class="nn">dl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">cumulative_trapezoid</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">from</span> <span class="nn">autodeer</span> <span class="kn">import</span> <span class="n">FieldSweepAnalysis</span><span class="p">,</span> <span class="n">ResonatorProfileAnalysis</span>
<span class="kn">import</span> <span class="nn">scipy.fft</span> <span class="k">as</span> <span class="nn">fft</span>
<span class="kn">from</span> <span class="nn">deerlab</span> <span class="kn">import</span> <span class="n">correctphase</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">sig</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span><span class="p">,</span><span class="n">brute</span>
<span class="kn">from</span> <span class="nn">autodeer.colors</span> <span class="kn">import</span> <span class="n">primary_colors</span><span class="p">,</span> <span class="n">ReIm_colors</span>
<span class="kn">from</span> <span class="nn">autodeer.utils</span> <span class="kn">import</span> <span class="n">round_step</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">signal</span>

<div class="viewcode-block" id="log">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.log">[docs]</a>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;autoDEER.DEER&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="MODULE_DIR">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.MODULE_DIR">[docs]</a>
<span class="n">MODULE_DIR</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s1">&#39;autodeer&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">submodule_search_locations</span></div>


<span class="c1"># =============================================================================</span>


<div class="viewcode-block" id="calc_identifiability">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.calc_identifiability">[docs]</a>
<span class="k">def</span> <span class="nf">calc_identifiability</span><span class="p">(</span><span class="n">profile</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
    <span class="n">fit_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span>
    <span class="n">fit_result</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">fit_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fit_result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>


<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="find_longest_pulse">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.find_longest_pulse">[docs]</a>
<span class="k">def</span> <span class="nf">find_longest_pulse</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the longest pulse duration in a given sequence.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">    sequence (Sequence): The sequence to analyze.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    float: The duration of the longest pulse in microseconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">longest_pulse</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pulse</span> <span class="ow">in</span> <span class="n">sequence</span><span class="o">.</span><span class="n">pulses</span><span class="p">:</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">pulse</span><span class="o">.</span><span class="n">tp</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">tp</span> <span class="o">&gt;</span> <span class="n">longest_pulse</span><span class="p">:</span>
            <span class="n">longest_pulse</span> <span class="o">=</span> <span class="n">tp</span>
    
    <span class="k">return</span> <span class="n">longest_pulse</span><span class="o">/</span><span class="mf">1e3</span></div>


<div class="viewcode-block" id="MNR_estimate">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.MNR_estimate">[docs]</a>
<span class="k">def</span> <span class="nf">MNR_estimate</span><span class="p">(</span><span class="n">Vexp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the Modulation to Noise Ratio (MNR) of a DEER signal without fitting.</span>
<span class="sd">    This is done by applying a low pass filter to remove noise and then finding the peaks in the signal.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Vexp : np.ndarray</span>
<span class="sd">        The experimental DEER signal, real part only.</span>
<span class="sd">    t : np.ndarray</span>
<span class="sd">        The time axis of the DEER signal, in microseconds.</span>
<span class="sd">    mask : np.ndarray, optional</span>
<span class="sd">        The mask to apply to the data, by default None</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The estimated MNR of the dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Vexp</span> <span class="o">=</span> <span class="n">Vexp</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">Vexp</span><span class="o">/=</span><span class="n">Vexp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    
    <span class="c1"># Vexp /= Vexp.max()</span>
    <span class="n">SNR</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dl</span><span class="o">.</span><span class="n">noiselevel</span><span class="p">(</span><span class="n">Vexp</span><span class="p">)</span>
    <span class="c1"># Smoothing spline with a low-pass filter</span>
    <span class="n">b</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># 3rd order Butterworth low-pass filter with cutoff at 0.1 MHz</span>
    <span class="n">Vexp_smooth</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">Vexp</span><span class="p">)</span>
    <span class="n">min_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Vexp_smooth</span><span class="p">)</span>
    <span class="n">N_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Vexp_smooth</span><span class="p">)</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span>
        <span class="n">Vexp_smooth</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">min_point</span><span class="p">,</span><span class="n">distance</span><span class="o">=</span><span class="n">N_points</span><span class="o">//</span><span class="mi">4</span><span class="p">)</span>
    
    <span class="n">est_lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">min_point</span><span class="p">)</span>
    <span class="n">MNR</span> <span class="o">=</span> <span class="n">est_lam</span><span class="o">*</span><span class="n">SNR</span>
    <span class="k">return</span> <span class="n">MNR</span></div>


<div class="viewcode-block" id="val_in_us">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.val_in_us">[docs]</a>
<span class="k">def</span> <span class="nf">val_in_us</span><span class="p">(</span><span class="n">Param</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Param</span><span class="o">.</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Param</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;us&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Param</span><span class="o">.</span><span class="n">value</span>
        <span class="k">elif</span> <span class="n">Param</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;ns&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Param</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mf">1e3</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">Param</span><span class="o">.</span><span class="n">axis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Param</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;us&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Param</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">Param</span><span class="o">.</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">Param</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;ns&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">Param</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">Param</span><span class="o">.</span><span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;axis&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e3</span> </div>



<span class="c1"># =============================================================================</span>
<div class="viewcode-block" id="DEERanalysis">
<a class="viewcode-back" href="../../autoapi/autodeer/index.html#autodeer.DEER_analysis.DEERanalysis">[docs]</a>
<span class="k">def</span> <span class="nf">DEERanalysis</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">compactness</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ROI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exp_type</span><span class="o">=</span><span class="s1">&#39;5pDEER&#39;</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">remove_crossing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>


    <span class="n">Vexp</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">data</span> 

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">Vexp</span><span class="p">):</span>
        <span class="n">Vexp</span><span class="p">,</span><span class="n">Vexp_im</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">correctphase</span><span class="p">(</span><span class="n">Vexp</span><span class="p">,</span><span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">remove_crossing</span><span class="p">:</span>
        <span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;Crossing removal only works with complex data. Skipping&quot;</span><span class="p">)</span>
        <span class="n">remove_crossing</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">Vexp</span> <span class="o">/=</span> <span class="n">Vexp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># Extract params from dataset</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="s2">&quot;sequence&quot;</span><span class="p">):</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sequence</span>
        <span class="k">if</span> <span class="n">sequence</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;4pDEER&quot;</span><span class="p">:</span>
            <span class="n">exp_type</span> <span class="o">=</span> <span class="s2">&quot;4pDEER&quot;</span>
            <span class="n">tau1</span> <span class="o">=</span> <span class="n">val_in_us</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">tau1</span><span class="p">)</span>
            <span class="n">tau2</span> <span class="o">=</span> <span class="n">val_in_us</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">tau2</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">sequence</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;5pDEER&quot;</span><span class="p">:</span>
            <span class="n">exp_type</span> <span class="o">=</span> <span class="s2">&quot;5pDEER&quot;</span>
            <span class="n">tau1</span> <span class="o">=</span> <span class="n">val_in_us</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">tau1</span><span class="p">)</span>
            <span class="n">tau2</span> <span class="o">=</span> <span class="n">val_in_us</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">tau2</span><span class="p">)</span>
            <span class="n">tau3</span> <span class="o">=</span> <span class="n">val_in_us</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">tau3</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">sequence</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;3pDEER&quot;</span><span class="p">:</span>
            <span class="n">exp_type</span> <span class="o">=</span> <span class="s2">&quot;3pDEER&quot;</span>
            <span class="n">tau1</span> <span class="o">=</span> <span class="n">val_in_us</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">tau1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">sequence</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;nDEER-CP&quot;</span><span class="p">:</span>
            <span class="n">exp_type</span> <span class="o">=</span> <span class="s2">&quot;4pDEER&quot;</span>
            <span class="n">tau1</span> <span class="o">=</span> <span class="n">val_in_us</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">tau1</span><span class="p">)</span>
            <span class="n">tau2</span> <span class="o">=</span> <span class="n">val_in_us</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">tau2</span><span class="p">)</span>

        <span class="n">tp</span> <span class="o">=</span> <span class="n">find_longest_pulse</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">val_in_us</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    
    <span class="k">elif</span> <span class="s1">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span> <span class="c1"># If the dataset is a xarray and has sequence data</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="s1">&#39;seq_name&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;seq_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4pDEER&quot;</span><span class="p">:</span>
                <span class="n">exp_type</span> <span class="o">=</span> <span class="s2">&quot;4pDEER&quot;</span>
                <span class="n">tau1</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span>
                <span class="n">tau2</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tau2&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span>
            <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;seq_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;5pDEER&quot;</span><span class="p">:</span>
                <span class="n">exp_type</span> <span class="o">=</span> <span class="s2">&quot;5pDEER&quot;</span>
                <span class="n">tau1</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span>
                <span class="n">tau2</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tau2&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span>
                <span class="n">tau3</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tau3&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span>
            <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;seq_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;3pDEER&quot;</span><span class="p">:</span>
                <span class="n">exp_type</span> <span class="o">=</span> <span class="s2">&quot;3pDEER&quot;</span>
                <span class="n">tau1</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;tau1&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">tau1</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span>
            <span class="k">elif</span> <span class="s1">&#39;tau1&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">tau1</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;tau1&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tau1 not found in dataset or kwargs&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;tau2&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">tau2</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tau2&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span>
            <span class="k">elif</span> <span class="s1">&#39;tau2&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">tau2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;tau2&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tau2 not found in dataset or kwargs&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;tau3&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                <span class="n">tau3</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;tau3&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e3</span>
                <span class="n">exp_type</span> <span class="o">=</span> <span class="s2">&quot;5pDEER&quot;</span>
            <span class="k">elif</span> <span class="s1">&#39;tau3&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">tau3</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;tau3&#39;</span><span class="p">)</span>
                <span class="n">exp_type</span> <span class="o">=</span> <span class="s2">&quot;5pDEER&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exp_type</span> <span class="o">=</span> <span class="s2">&quot;4pDEER&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Extract params from kwargs</span>
        <span class="k">if</span> <span class="s2">&quot;tau1&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">tau1</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tau1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;tau2&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">tau2</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tau2&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;tau3&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">tau3</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;tau3&quot;</span><span class="p">)</span>
        <span class="n">exp_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;exp_type&quot;</span><span class="p">)</span>
        <span class="c1"># t = dataset.axes[0]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">/=</span> <span class="mf">1e3</span>

    <span class="c1"># Find mask if needed</span>

    <span class="k">if</span> <span class="n">remove_crossing</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;pcyc_name&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="n">pcyc</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pcyc_name&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;nPcyc&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span> <span class="c1"># guess pcyc</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nPcyc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
                <span class="n">pcyc</span> <span class="o">=</span> <span class="s1">&#39;Full&#39;</span>
            <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;nPcyc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">pcyc</span> <span class="o">=</span> <span class="s1">&#39;DC&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pcyc</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>

        <span class="k">if</span> <span class="n">pcyc</span> <span class="o">==</span> <span class="s1">&#39;DC&#39;</span> <span class="ow">and</span> <span class="n">exp_type</span> <span class="o">==</span> <span class="s2">&quot;5pDEER&quot;</span><span class="p">:</span> <span class="c1"># Remove crossing echoes</span>
            <span class="n">t_position</span> <span class="o">=</span> <span class="p">[</span><span class="n">tau1</span> <span class="o">+</span> <span class="n">tau2</span> <span class="o">-</span> <span class="n">tau3</span><span class="p">]</span>
            <span class="n">idx_position</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cross</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">cross</span> <span class="ow">in</span> <span class="n">t_position</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">Vexp</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">idx_position</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">remove_echo</span><span class="p">(</span><span class="n">Vexp</span><span class="p">,</span> <span class="n">Vexp_im</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;mask&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>
        <span class="n">noiselvl</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">noiselevel</span><span class="p">(</span><span class="n">Vexp</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">remove_crossing</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">noiselvl</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">noiselevel</span><span class="p">(</span><span class="n">Vexp</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">noiselvl</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">noiselevel</span><span class="p">(</span><span class="n">Vexp</span><span class="p">)</span>
        <span class="n">mask</span><span class="o">=</span><span class="kc">None</span>

    <span class="c1"># Determine the pathways</span>
    <span class="n">est_MNR</span> <span class="o">=</span> <span class="n">MNR_estimate</span><span class="p">(</span><span class="n">Vexp</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;pathways&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">pathways</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pathways&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">exp_type</span> <span class="o">==</span> <span class="s1">&#39;4pDEER&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">est_MNR</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
                <span class="n">pathways</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pathways</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">exp_type</span> <span class="o">==</span> <span class="s1">&#39;5pDEER&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">est_MNR</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
                <span class="n">pathways</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pathways</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">exp_type</span> <span class="o">==</span> <span class="s1">&#39;3pDEER&#39;</span><span class="p">:</span>
            <span class="n">pathways</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pathways</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Compactness is only needed with model-free fitting</span>
        <span class="n">compactness</span> <span class="o">=</span> <span class="kc">False</span>
    

    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experiment type: </span><span class="si">{</span><span class="n">exp_type</span><span class="si">}</span><span class="s2">, pathways: </span><span class="si">{</span><span class="n">pathways</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experimental Parameters set to: tau1 </span><span class="si">{</span><span class="n">tau1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> us </span><span class="se">\t</span><span class="s2"> tau2 </span><span class="si">{</span><span class="n">tau2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> us&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="s2">&quot;sequence&quot;</span><span class="p">):</span>
        <span class="n">pulselength</span> <span class="o">=</span> <span class="n">tp</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="s1">&#39;attrs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;pulse0_tp&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="c1"># seach over all pulses to find the longest pulse using regex</span>
        <span class="n">pulselength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;pulse\d*_tp&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)])</span>
        <span class="n">pulselength</span> <span class="o">/=</span> <span class="mf">1e3</span> <span class="c1"># Convert to us</span>
        <span class="n">pulselength</span> <span class="o">/=</span> <span class="mi">2</span> <span class="c1"># Account for the too long range permitted by deerlab</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;pulselength&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">pulselength</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pulselength&quot;</span><span class="p">)</span><span class="o">/</span><span class="mf">1e3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pulselength</span> <span class="o">=</span> <span class="mi">16</span><span class="o">/</span><span class="mf">1e3</span>
        
    <span class="k">if</span> <span class="n">exp_type</span> <span class="o">==</span> <span class="s2">&quot;4pDEER&quot;</span><span class="p">:</span>
        <span class="n">experimentInfo</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">ex_4pdeer</span><span class="p">(</span><span class="n">tau1</span><span class="o">=</span><span class="n">tau1</span><span class="p">,</span><span class="n">tau2</span><span class="o">=</span><span class="n">tau2</span><span class="p">,</span><span class="n">pathways</span><span class="o">=</span><span class="n">pathways</span><span class="p">,</span><span class="n">pulselength</span><span class="o">=</span><span class="n">pulselength</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">exp_type</span> <span class="o">==</span> <span class="s2">&quot;5pDEER&quot;</span><span class="p">:</span>
        <span class="n">experimentInfo</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">ex_fwd5pdeer</span><span class="p">(</span><span class="n">tau1</span><span class="o">=</span><span class="n">tau1</span><span class="p">,</span><span class="n">tau2</span><span class="o">=</span><span class="n">tau2</span><span class="p">,</span><span class="n">tau3</span><span class="o">=</span><span class="n">tau3</span><span class="p">,</span><span class="n">pathways</span><span class="o">=</span><span class="n">pathways</span><span class="p">,</span><span class="n">pulselength</span><span class="o">=</span><span class="n">pulselength</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">exp_type</span> <span class="o">==</span> <span class="s2">&quot;3pDEER&quot;</span><span class="p">:</span>
        <span class="n">experimentInfo</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">ex_3pdeer</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau1</span><span class="p">,</span><span class="n">pathways</span><span class="o">=</span><span class="n">pathways</span><span class="p">,</span><span class="n">pulselength</span><span class="o">=</span><span class="n">pulselength</span><span class="p">)</span>

  
    <span class="n">r_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mi">6</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="n">r_max</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>


        

    <span class="c1"># identify experiment</span>
    <span class="k">if</span> <span class="s1">&#39;parametrization&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">parametrization</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;parametrization&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parametrization</span> <span class="o">=</span> <span class="s1">&#39;reftimes&#39;</span>

    
    <span class="k">if</span> <span class="s1">&#39;Vmodel&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">Vmodel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Vmodel&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Vmodel</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">dipolarmodel</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">experiment</span><span class="o">=</span><span class="n">experimentInfo</span><span class="p">,</span> <span class="n">Pmodel</span><span class="o">=</span><span class="n">model</span><span class="p">,</span><span class="n">parametrization</span><span class="o">=</span><span class="n">parametrization</span><span class="p">)</span>
        <span class="n">Vmodel</span><span class="o">.</span><span class="n">pathways</span> <span class="o">=</span> <span class="n">pathways</span>

    <span class="k">if</span> <span class="n">compactness</span><span class="p">:</span>
        <span class="n">compactness_penalty</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">dipolarpenalty</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="s1">&#39;compactness&#39;</span><span class="p">,</span> <span class="s1">&#39;icc&#39;</span><span class="p">)</span>
        <span class="n">compactness_penalty</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">lb</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="mf">2e-1</span><span class="p">)</span>
        <span class="c1"># compactness_penalty.weight.freeze(0.04)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">compactness_penalty</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="c1"># Cleanup extra args</span>
    <span class="n">extra_args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">,</span><span class="s1">&#39;tau2&#39;</span><span class="p">,</span><span class="s1">&#39;tau3&#39;</span><span class="p">,</span><span class="s1">&#39;exp_type&#39;</span><span class="p">,</span><span class="s1">&#39;model&#39;</span><span class="p">,</span><span class="s1">&#39;compactness&#39;</span><span class="p">,</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span><span class="s1">&#39;verbosity&#39;</span><span class="p">,</span><span class="s1">&#39;pulselength&#39;</span><span class="p">,</span><span class="s1">&#39;Vmodel&#39;</span><span class="p">,</span><span class="s1">&#39;parametrization&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">extra_args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="c1"># Core </span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting Fitting&#39;</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Vmodel</span><span class="p">,</span> <span class="n">Vexp</span><span class="p">,</span> <span class="n">penalties</span><span class="o">=</span><span class="n">compactness_penalty</span><span class="p">,</span> 
                 <span class="n">noiselvl</span><span class="o">=</span><span class="n">noiselvl</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fit complete&#39;</span><span class="p">)</span>
    <span class="n">mod_labels</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(lam\d*)&#39;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">if</span> <span class="n">mod_labels</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">mod_labels</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">]</span>

    <span class="n">lam</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">mod_labels</span><span class="p">:</span>
        <span class="n">lam</span> <span class="o">+=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>

    <span class="n">MNR</span> <span class="o">=</span> <span class="n">lam</span><span class="o">/</span><span class="n">fit</span><span class="o">.</span><span class="n">noiselvl</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">MNR</span> <span class="o">=</span> <span class="n">MNR</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">lam</span> <span class="o">=</span> <span class="n">lam</span>


    <span class="n">fit</span><span class="o">.</span><span class="n">Vmodel</span> <span class="o">=</span> <span class="n">Vmodel</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">Vexp</span> <span class="o">=</span> <span class="n">Vexp</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">):</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">PUncert</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">r</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
    
    
    <span class="k">if</span> <span class="n">ROI</span><span class="p">:</span>
        <span class="c1"># tau_max = lambda r: (r**3) *(3/4**3)</span>
        <span class="n">tau_max</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span>  <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">ROI</span> <span class="o">=</span> <span class="n">IdentifyROI</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="mf">0.90</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;gauss&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fit</span><span class="o">.</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fit</span><span class="o">.</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">rec_tau_max</span> <span class="o">=</span> <span class="n">tau_max</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">rec_tau_max</span> <span class="o">=</span> <span class="n">rec_tau_max</span>
        <span class="n">dt_rec</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span><span class="mf">0.85</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mf">52.04</span><span class="p">)</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">rec_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">dt_rec</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mf">10e-3</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fit</span><span class="p">,</span> <span class="n">rec_tau_max</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fit</span><span class="o">.</span><span class="n">ROI</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">return</span> <span class="n">fit</span></div>

    


<span class="c1"># =============================================================================</span>
<span class="c1"># Plotting</span>
<span class="c1"># =============================================================================</span>
    
<div class="viewcode-block" id="background_func">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.background_func">[docs]</a>
<span class="k">def</span> <span class="nf">background_func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fit</span><span class="p">):</span>
    <span class="n">Vmodel</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">Vmodel</span>
    <span class="n">pathways</span> <span class="o">=</span> <span class="n">Vmodel</span><span class="o">.</span><span class="n">pathways</span>
    <span class="n">conc</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">conc</span>
    <span class="n">prod</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathways</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pathways</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="c1"># linked pathway</span>
                <span class="n">lam</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;lam</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}{</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">scale</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">lam</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">reftime</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;reftime</span><span class="si">{</span><span class="n">pathways</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">prod</span> <span class="o">*=</span> <span class="n">dl</span><span class="o">.</span><span class="n">bg_hom3d</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">reftime</span><span class="p">,</span> <span class="n">conc</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">reftime</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;reftime</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">lam</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;lam</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">prod</span> <span class="o">*=</span> <span class="n">dl</span><span class="o">.</span><span class="n">bg_hom3d</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">reftime</span><span class="p">,</span> <span class="n">conc</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
                <span class="n">scale</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">lam</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reftime</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;reftime&quot;</span><span class="p">)</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;mod&quot;</span><span class="p">)</span>
        <span class="n">prod</span> <span class="o">*=</span> <span class="n">dl</span><span class="o">.</span><span class="n">bg_hom3d</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">reftime</span><span class="p">,</span> <span class="n">conc</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">lam</span>
    
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span><span class="s1">&#39;P_scale&#39;</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">*=</span> <span class="n">fit</span><span class="o">.</span><span class="n">P_scale</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span><span class="s1">&#39;scale&#39;</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">*=</span> <span class="n">fit</span><span class="o">.</span><span class="n">scale</span>

    <span class="k">return</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">prod</span></div>


<div class="viewcode-block" id="calc_correction_factor">
<a class="viewcode-back" href="../../autoapi/autodeer/index.html#autodeer.DEER_analysis.calc_correction_factor">[docs]</a>
<span class="k">def</span> <span class="nf">calc_correction_factor</span><span class="p">(</span><span class="n">fit_result</span><span class="p">,</span><span class="n">aim_MNR</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">aim_time</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the correction factor for the number of averages required to achieve a given MNR in a given time.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fit_result : Deerlab.FitResult</span>
<span class="sd">        The fit result from the DEER analysis.</span>
<span class="sd">    aim_MNR : float, optional</span>
<span class="sd">        The desired MNR, by default 25</span>
<span class="sd">    aim_time : float, optional</span>
<span class="sd">        The desired time in hours, by default 2</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The correction factor for the number of averages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">dataset</span>
    <span class="n">runtime_s</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">nAvgs</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">nPcyc</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shots</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">reptime</span> <span class="o">*</span> <span class="n">dataset</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span>
    <span class="n">aim_time</span> <span class="o">*=</span> <span class="mi">3600</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">MNR</span> <span class="o">/</span><span class="n">aim_MNR</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">aim_time</span><span class="o">/</span><span class="n">runtime_s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">factor</span></div>


<div class="viewcode-block" id="DEERanalysis_plot">
<a class="viewcode-back" href="../../autoapi/autodeer/index.html#autodeer.DEER_analysis.DEERanalysis_plot">[docs]</a>
<span class="k">def</span> <span class="nf">DEERanalysis_plot</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">background</span><span class="p">:</span><span class="nb">bool</span><span class="p">,</span> <span class="n">ROI</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DEERanalysis_plot Generates a figure showing both the time domain and</span>
<span class="sd">    distance domain data along with extra important infomation such as the </span>
<span class="sd">    Modulation to Noise Ratio (MNR), Region of Interest (ROI) and the </span>
<span class="sd">    recommended dipolar evolution time for future experiments based upon the </span>
<span class="sd">    ROI.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fit : Deerlab.FitResult</span>
<span class="sd">        _description_</span>
<span class="sd">    background : bool</span>
<span class="sd">        Should the background fit be plotted.</span>
<span class="sd">    ROI : tuple, optional</span>
<span class="sd">        The minimum and maximum of the Region of Interest (ROI),</span>
<span class="sd">        by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Figure</span>
<span class="sd">        A Matplotlib Figure object of the figure. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">t</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">r</span>
    <span class="n">Vexp</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">Vexp</span>
    <span class="n">Vfit</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">model</span>
    <span class="n">Vmodel</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">Vmodel</span>
    <span class="n">pathways</span> <span class="o">=</span> <span class="n">Vmodel</span><span class="o">.</span><span class="n">pathways</span>

    <span class="c1"># Calculate background</span>
    <span class="k">def</span> <span class="nf">background_func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fit</span><span class="p">):</span>
        <span class="n">conc</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">conc</span>
        <span class="n">prod</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pathways</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="c1"># linked pathway</span>
                <span class="n">lam</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;lam</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}{</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">scale</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">lam</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">reftime</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;reftime</span><span class="si">{</span><span class="n">pathways</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">prod</span> <span class="o">*=</span> <span class="n">dl</span><span class="o">.</span><span class="n">bg_hom3d</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">reftime</span><span class="p">,</span> <span class="n">conc</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">reftime</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;reftime</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">lam</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;lam</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">prod</span> <span class="o">*=</span> <span class="n">dl</span><span class="o">.</span><span class="n">bg_hom3d</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">reftime</span><span class="p">,</span> <span class="n">conc</span><span class="p">,</span> <span class="n">lam</span><span class="p">)</span>
                <span class="n">scale</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">lam</span>

        <span class="k">return</span> <span class="n">fit</span><span class="o">.</span><span class="n">P_scale</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">prod</span>

    <span class="k">if</span> <span class="n">axs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">([</span>
            <span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">,</span> <span class="s1">&#39;Primary_time&#39;</span><span class="p">,</span> <span class="s1">&#39;Primary_dist&#39;</span><span class="p">,</span> <span class="s1">&#39;Primary_dist&#39;</span><span class="p">]</span>
            <span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">12.5</span><span class="p">,</span> <span class="mf">6.28</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="c1"># Time </span>

    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">Vexp</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.7&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">Vexp</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Vexp</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.7&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Vfit</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">primary_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
    <span class="c1"># axs[&#39;Primary_time&#39;].fill_between(t, Vci[:, 0], Vci[:, 1], color=&#39;C1&#39;,</span>
    <span class="c1">#                                  alpha=0.3)</span>
    <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">t</span><span class="p">,</span> <span class="n">background_func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fit</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">primary_colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Unmod. Cont.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Time / $\mu s$&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;A.U.&quot;</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Distance Plots</span>
    <span class="n">Pfit</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">P</span>
    <span class="n">Pci</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">PUncert</span><span class="o">.</span><span class="n">ci</span><span class="p">(</span><span class="mi">95</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Pfit</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">primary_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">Pci</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Pci</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">primary_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% CI&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ROI</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Pci</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">primary_colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    
    <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Distance / $ nm$&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$P(r) / nm^{-1}$&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span>
    <span class="c1"># Analysis</span>
    <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;MNR: </span><span class="si">{</span><span class="n">fit</span><span class="o">.</span><span class="n">MNR</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;16&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fit</span><span class="o">.</span><span class="n">MNR</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;LOW MNR: More averages requried&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;16&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ROI</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ROI_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
        <span class="n">rec_tau_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ROI: </span><span class="si">{</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">nm to </span><span class="si">{</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">nm&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;16&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="sa">rf</span><span class="s2">&quot;Recommended $\tau_</span><span class="se">{{</span><span class="s2">max</span><span class="se">}}</span><span class="s2">$ = </span><span class="si">{</span><span class="n">rec_tau_max</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">us&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;16&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ROI_error</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="s1">&#39;Primary_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="sa">rf</span><span class="s2">&quot;ROI is too close to $r_</span><span class="se">{{</span><span class="s2">max</span><span class="se">}}</span><span class="s2">$. Increase $\tau_</span><span class="se">{{</span><span class="s2">max</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;x-large&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="DEERanalysis_plot_pub">
<a class="viewcode-back" href="../../autoapi/autodeer/index.html#autodeer.DEER_analysis.DEERanalysis_plot_pub">[docs]</a>
<span class="k">def</span> <span class="nf">DEERanalysis_plot_pub</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">ROI</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a vertical plot of the DEER analysis results, ready for publication.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    results : Deerlab.FitResult</span>
<span class="sd">        The results of the DEER analysis.</span>
<span class="sd">    ROI : tuple, optional</span>
<span class="sd">        The minimum and maximum of the Region of Interest (ROI),</span>
<span class="sd">        by default None</span>
<span class="sd">    fig : matplotlib.figure.Figure, optional</span>
<span class="sd">        The figure to plot the results on. If None, a new figure is created.</span>
<span class="sd">    axs : matplotlib.axes.Axes, optional</span>
<span class="sd">        The axes to plot the results on. If None, a new axes is created.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">mask</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">t</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">r</span>
    <span class="n">Vexp</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">Vexp</span>
    <span class="n">Vfit</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">model</span>
    <span class="n">Vmodel</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">Vmodel</span>
    <span class="n">pathways</span> <span class="o">=</span> <span class="n">Vmodel</span><span class="o">.</span><span class="n">pathways</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{},</span><span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;hspace&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{},</span><span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;hspace&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">})</span>
    
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">results</span><span class="o">.</span><span class="n">Vexp</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#D95B6F&#39;</span><span class="p">,</span><span class="n">mec</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">results</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#D95B6F&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">t</span><span class="p">,</span><span class="n">background_func</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">results</span><span class="p">),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#42A399&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time / $\mu s$&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_top</span><span class="p">()</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span> 

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Signal A.U.&#39;</span><span class="p">)</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">r</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">results</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#D95B6F&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;P(r)&#39;</span><span class="p">)</span>
    <span class="n">Pci</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">PUncert</span><span class="o">.</span><span class="n">ci</span><span class="p">(</span><span class="mi">95</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">Pci</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Pci</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#D95B6F&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;P(r) 95% CI&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ROI</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Pci</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#42A399&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance / $nm$&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$P(r) / nm^{-1}$&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span></div>


<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="IdentifyROI">
<a class="viewcode-back" href="../../autoapi/autodeer/index.html#autodeer.DEER_analysis.IdentifyROI">[docs]</a>
<span class="k">def</span> <span class="nf">IdentifyROI</span><span class="p">(</span>
        <span class="n">P</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">criterion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gauss&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;IdentifyROI Identifies the region of interest. Two methods are sypported</span>

<span class="sd">    Methods</span>
<span class="sd">    +++++++</span>
<span class="sd">    </span>
<span class="sd">    1. Gaussian fitting (&quot;gauss&quot;):</span>

<span class="sd">    2. Intergration (&quot;int&quot;):</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : np.ndarray</span>
<span class="sd">        The distance distribution.</span>
<span class="sd">    r : np.ndarray</span>
<span class="sd">        The distance axis</span>
<span class="sd">    criterion : float, optional</span>
<span class="sd">        The fraction of the distance distribution that must be in the ROI, by </span>
<span class="sd">        default 0.99</span>
<span class="sd">    method: str, optional</span>
<span class="sd">        The method used to calculate region of interest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
        <span class="c1"># Normlaize the distribution</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">P</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="c1"># cumulative_dist = cumulative_trapezoid(dist,r,initial=0)</span>
        <span class="c1"># min_dist = r[np.argmin(np.abs(1 - cumulative_dist - criterion))]</span>
        <span class="c1"># max_dist = r[np.argmin(np.abs(cumulative_dist - criterion))]</span>

        <span class="n">c_trapz_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">c_trapz_dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">:]</span> <span class="o">=</span> <span class="n">cumulative_trapezoid</span><span class="p">(</span>
                <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">c_trapz_dist</span><span class="p">[(</span><span class="n">c_trapz_dist</span> <span class="o">&lt;</span> <span class="n">criterion</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">c_trapz_dist</span><span class="p">),</span> <span class="n">c_trapz_dist</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">min_dist</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">max_dist</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># Enlarge ROI</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">max_dist</span> <span class="o">-</span> <span class="n">min_dist</span>
        <span class="n">max_dist</span> <span class="o">=</span> <span class="n">max_dist</span> <span class="o">+</span> <span class="n">width</span> <span class="o">*</span> <span class="mf">0.25</span>
        <span class="n">min_dist</span> <span class="o">=</span> <span class="n">min_dist</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="mf">0.25</span>

    <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gauss&quot;</span><span class="p">:</span>

        <span class="c1"># Single gaussian approach</span>
        <span class="n">Pmodel</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">dd_gauss</span>
        <span class="n">Pmodel</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">lb</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">Pmodel</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">ub</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span><span class="mi">2</span>
        <span class="n">Pmodel</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">par0</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">P</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
        <span class="n">Pmodel</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">lb</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">Pmodel</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">ub</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">Pmodel</span><span class="o">.</span><span class="n">std</span><span class="o">.</span><span class="n">par0</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">*</span><span class="mf">0.5</span>
        <span class="n">fit2</span> <span class="o">=</span> <span class="n">dl</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Pmodel</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">min_dist</span> <span class="o">=</span> <span class="n">fit2</span><span class="o">.</span><span class="n">mean</span> <span class="o">-</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">fit2</span><span class="o">.</span><span class="n">std</span>
        <span class="n">max_dist</span> <span class="o">=</span> <span class="n">fit2</span><span class="o">.</span><span class="n">mean</span> <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">fit2</span><span class="o">.</span><span class="n">std</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">min_dist</span><span class="p">,</span> <span class="n">max_dist</span><span class="p">]</span></div>



<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="remove_echo">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.remove_echo">[docs]</a>
<span class="k">def</span> <span class="nf">remove_echo</span><span class="p">(</span>
        <span class="n">Vre</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Vim</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">loc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">criteria</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">extent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function removes crossing echoes. </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Vre : np.ndarray</span>
<span class="sd">        The real part of the phase corrected signal.</span>
<span class="sd">    Vim : np.ndarray</span>
<span class="sd">        The imaginary part of the phase corrected signal.</span>
<span class="sd">    loc : int</span>
<span class="sd">        The approximate location of the crossing echo, +- 30 data points</span>
<span class="sd">    criteria : float, optional</span>
<span class="sd">        The detection criteria, in multiples of the std deviation, by default 4</span>
<span class="sd">    extent : int, optional</span>
<span class="sd">        How many data points either side to remove, by default 3.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        The mask of points to be ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">search_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Vre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
    <span class="n">search_mask</span><span class="p">[</span><span class="n">loc</span><span class="o">-</span><span class="mi">30</span><span class="p">:</span><span class="n">loc</span><span class="o">+</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Vim</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Vim</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">criteria</span> <span class="o">*</span> \
        <span class="n">dl</span><span class="o">.</span><span class="n">noiselevel</span><span class="p">(</span><span class="n">Vre</span><span class="p">[</span><span class="n">search_mask</span><span class="p">])</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">search_mask</span><span class="p">)</span>
    <span class="n">iskip</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iskip</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">extent</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">-</span> <span class="n">extent</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">extent</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">iskip</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">extent</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Optimising pulse postions</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="shift_pulse_freq">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.shift_pulse_freq">[docs]</a>
<span class="k">def</span> <span class="nf">shift_pulse_freq</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shifts the frequency of a pulse by a given amount.</span>

<span class="sd">    Args:</span>
<span class="sd">        pulse: The pulse whose frequency should be shifted.</span>
<span class="sd">        shift: The amount by which to shift the frequency.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The pulse with the shifted frequency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">):</span>
        <span class="n">pulse</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">shift</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="s1">&#39;init_freq&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="s1">&#39;final_freq&#39;</span><span class="p">):</span>
        <span class="n">pulse</span><span class="o">.</span><span class="n">init_freq</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">shift</span>
        <span class="n">pulse</span><span class="o">.</span><span class="n">final_freq</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">shift</span>
    <span class="k">return</span> <span class="n">pulse</span></div>


<div class="viewcode-block" id="normalise_01">
<a class="viewcode-back" href="../../autoapi/autodeer/index.html#autodeer.DEER_analysis.normalise_01">[docs]</a>
<span class="k">def</span> <span class="nf">normalise_01</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalizes the input vector A to be between 0 and 1.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    A (numpy.ndarray): Input vector to be normalized.</span>

<span class="sd">    Returns:</span>
<span class="sd">    numpy.ndarray: Normalized vector between 0 and 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">A</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span></div>


<div class="viewcode-block" id="resample_and_shift_vector">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.resample_and_shift_vector">[docs]</a>
<span class="k">def</span> <span class="nf">resample_and_shift_vector</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">shift</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resample the vector A along axis f and shift it by shift and return on original axis f.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    A (numpy.ndarray): The input vector to be resampled and shifted.</span>
<span class="sd">    f (numpy.ndarray): The axis along which to resample the vector.</span>
<span class="sd">    shift (float): The amount by which to shift the resampled vector.</span>

<span class="sd">    Returns:</span>
<span class="sd">    numpy.ndarray: The resampled and shifted vector.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="o">+</span><span class="n">shift</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">A</span></div>



<div class="viewcode-block" id="build__lowpass_butter_filter">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.build__lowpass_butter_filter">[docs]</a>
<span class="k">def</span> <span class="nf">build__lowpass_butter_filter</span><span class="p">(</span><span class="n">cutoff</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a lowpass butterworth filter with a cutoff frequency of cutoff</span>

<span class="sd">    Args:</span>
<span class="sd">        cutoff (float): cutoff frequency in GHz</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sos</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="n">btype</span><span class="o">=</span><span class="s1">&#39;lowpass&#39;</span><span class="p">,</span><span class="n">analog</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">filter_func</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f</span>
        <span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">freqs</span><span class="p">(</span><span class="o">*</span><span class="n">sos</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filter_func</span></div>


<div class="viewcode-block" id="functional">
<a class="viewcode-back" href="../../autoapi/autodeer/DEER_analysis/index.html#autodeer.DEER_analysis.functional">[docs]</a>
<span class="k">def</span> <span class="nf">functional</span><span class="p">(</span><span class="n">f_axis</span><span class="p">,</span><span class="n">fieldsweep</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">A_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">B_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Functional for optimising the pulse positions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    f_axis : np.ndarray</span>
<span class="sd">        The frequency axis of the field sweep in GHz</span>
<span class="sd">    fieldsweep : ad.FieldSweepAnalysis</span>
<span class="sd">        The FieldSweep analysis object</span>
<span class="sd">    A : np.ndarray</span>
<span class="sd">        The pump pulse profile</span>
<span class="sd">    B : np.ndarray</span>
<span class="sd">        The effective excitation pulse profile</span>
<span class="sd">    filter : np.ndarray, optional</span>
<span class="sd">        The filter profile if applicable, by default None</span>
<span class="sd">    A_shift : int, optional</span>
<span class="sd">        The shift in pump pulse in GHz, by default 0</span>
<span class="sd">    B_shift : int, optional</span>
<span class="sd">        The shift in effective exciatation pulse in GHz, by default 0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _type_</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">D_profile</span> <span class="o">=</span> <span class="n">resample_and_shift_vector</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">f_axis</span><span class="p">,</span><span class="n">A_shift</span><span class="p">)</span><span class="o">*</span><span class="n">fieldsweep</span><span class="o">*</span><span class="n">resample_and_shift_vector</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">f_axis</span><span class="p">,</span><span class="n">B_shift</span><span class="p">)</span>
    <span class="n">A_profile</span> <span class="o">=</span> <span class="n">fieldsweep</span><span class="o">*</span><span class="p">(</span><span class="n">resample_and_shift_vector</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">f_axis</span><span class="p">,</span><span class="n">A_shift</span><span class="p">))</span><span class="o">-</span><span class="n">D_profile</span> <span class="c1"># Pump</span>
    <span class="n">B_profile</span> <span class="o">=</span> <span class="n">fieldsweep</span><span class="o">*</span><span class="p">(</span><span class="n">resample_and_shift_vector</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">f_axis</span><span class="p">,</span><span class="n">B_shift</span><span class="p">))</span><span class="o">-</span><span class="n">D_profile</span> <span class="c1"># Exc</span>
    <span class="n">fsweep_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">fieldsweep</span><span class="p">,</span><span class="n">f_axis</span><span class="p">)</span>
    <span class="n">Aspins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">A_profile</span><span class="p">,</span><span class="n">f_axis</span><span class="p">)</span><span class="o">/</span><span class="n">fsweep_norm</span>

    <span class="k">if</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Bspins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">B_profile</span><span class="p">,</span><span class="n">f_axis</span><span class="p">)</span><span class="o">/</span><span class="n">fsweep_norm</span>
        <span class="n">Noise</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Bspins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">B_profile</span><span class="o">*</span><span class="n">resample_and_shift_vector</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span><span class="n">f_axis</span><span class="p">,</span><span class="n">B_shift</span><span class="p">),</span><span class="n">f_axis</span><span class="p">)</span><span class="o">/</span><span class="n">fsweep_norm</span>
        <span class="n">Noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span><span class="n">f_axis</span><span class="p">)</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">Aspins</span> <span class="o">*</span> <span class="n">Bspins</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Noise</span><span class="p">)</span></div>



<div class="viewcode-block" id="optimise_pulses">
<a class="viewcode-back" href="../../autoapi/autodeer/index.html#autodeer.DEER_analysis.optimise_pulses">[docs]</a>
<span class="k">def</span> <span class="nf">optimise_pulses</span><span class="p">(</span><span class="n">Fieldsweep</span><span class="p">,</span> <span class="n">pump_pulse</span><span class="p">,</span> <span class="n">exc_pulse</span><span class="p">,</span> <span class="n">ref_pulse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;brute&#39;</span><span class="p">,</span>
                    <span class="n">nDEER</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_ref_pulses</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resonator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Optimise the pulse positions to maximise the pump-exc overlap.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Fieldsweep : ad.FieldSweepAnalysis</span>
<span class="sd">        The FieldSweep analysis object</span>
<span class="sd">    pump_pulse : ad.Pulse</span>
<span class="sd">        The pump pulse object</span>
<span class="sd">    exc_pulse : ad.Pulse</span>
<span class="sd">        The excitation pulse object</span>
<span class="sd">    ref_pulse : ad.Pulse, optional</span>
<span class="sd">        The refocusing pulse object\, by default None</span>
<span class="sd">    filter : str or number or list, optional</span>
<span class="sd">        The filter profile if applicable, by default None. If it is a number a filter is generated with this cutoff frequency.</span>
<span class="sd">        If the string &#39;Matched&#39; is used a matched filter is used. If a list is used the optimisation is performed for each filter and the best is returned.</span>
<span class="sd">    verbosity : int, optional</span>
<span class="sd">        The verbosity, by default 0</span>
<span class="sd">    method : str, optional</span>
<span class="sd">        What search optimisation is used, by default &#39;grid&#39;</span>
<span class="sd">    nDEER : bool, optional</span>
<span class="sd">        Is the sequence an nDEER sequrence, by default False. If True then the refocusing pulse is not optimised.</span>
<span class="sd">    num_ref_pulses : int, optional</span>
<span class="sd">        The total number of refocusing pulses, by default 2</span>
<span class="sd">    full_output : bool, optional</span>
<span class="sd">        Return the full output, by default False</span>
<span class="sd">    resonator : ad.ResonatorProfile, optional</span>
<span class="sd">        The resonator profile, by default None</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ad.Pulse</span>
<span class="sd">        The optimised pump pulse</span>
<span class="sd">    ad.Pulse</span>
<span class="sd">        The optimised excitation pulse</span>
<span class="sd">    ad.Pulse</span>
<span class="sd">        The optimised refocusing pulse</span>
<span class="sd">    str or number</span>
<span class="sd">        The best filter, only if a list of filters is provided</span>
<span class="sd">    float</span>
<span class="sd">        The functional value after optimisation, only if full_output is True</span>
<span class="sd">    tuple</span>
<span class="sd">        The grid of the optimisation, only if full_output is True</span>
<span class="sd">    tuple</span>
<span class="sd">        The output of the optimisation, only if full_output is True</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1"># gyro  = Fieldsweep.gyro</span>
    <span class="c1"># if hasattr(Fieldsweep,&#39;results&#39;):</span>
    <span class="c1">#     fieldsweep_fun = lambda x: Fieldsweep.results.evaluate(Fieldsweep.model,(x+Fieldsweep.LO) /gyro*1e-1)</span>
    <span class="n">fieldsweep_fun</span> <span class="o">=</span> <span class="n">Fieldsweep</span><span class="o">.</span><span class="n">func_freq</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.3</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">fieldsweep_profile</span> <span class="o">=</span> <span class="n">fieldsweep_fun</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># fieldsweep_profile = np.flip(fieldsweep_fun(f))</span>
    
    <span class="n">pump_Mz</span> <span class="o">=</span> <span class="n">normalise_01</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">pump_pulse</span><span class="o">.</span><span class="n">exciteprofile</span><span class="p">(</span><span class="n">freqs</span><span class="o">=</span><span class="n">f</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="n">exc_Mz</span> <span class="o">=</span> <span class="n">normalise_01</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">exc_pulse</span><span class="o">.</span><span class="n">exciteprofile</span><span class="p">(</span><span class="n">freqs</span><span class="o">=</span><span class="n">f</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ref_pulse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_ref_pulses</span><span class="p">):</span>
            <span class="n">exc_Mz</span> <span class="o">*=</span> <span class="n">normalise_01</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">ref_pulse</span><span class="o">.</span><span class="n">exciteprofile</span><span class="p">(</span><span class="n">freqs</span><span class="o">=</span><span class="n">f</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="nb">filter</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">filter</span> <span class="o">==</span> <span class="s1">&#39;Matched&#39;</span><span class="p">:</span>
            <span class="c1"># Matched filter</span>
            <span class="n">filter_profile</span> <span class="o">=</span> <span class="n">exc_Mz</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="n">filter_profile</span> <span class="o">=</span> <span class="n">build__lowpass_butter_filter</span><span class="p">(</span><span class="nb">filter</span><span class="p">)(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filter_profile</span> <span class="o">=</span> <span class="kc">None</span>
            

        <span class="n">fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">functional</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fieldsweep_profile</span><span class="p">,</span> <span class="n">pump_Mz</span><span class="p">,</span> <span class="n">exc_Mz</span><span class="p">,</span><span class="n">filter_profile</span><span class="p">,</span><span class="n">A_shift</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">B_shift</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="p">[</span><span class="n">fun</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">())]</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">f_idA</span><span class="p">,</span><span class="n">f_idB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">argmin</span><span class="p">(),</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">fA</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">f_idA</span><span class="p">]</span>
            <span class="n">fB</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">f_idB</span><span class="p">]</span>
            <span class="n">fval</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
            <span class="n">Jout</span> <span class="o">=</span> <span class="n">Z</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;brute&#39;</span><span class="p">:</span>
            <span class="p">[</span><span class="n">fA</span><span class="p">,</span><span class="n">fB</span><span class="p">]</span> <span class="p">,</span><span class="n">fval</span><span class="p">,</span><span class="n">grid</span><span class="p">,</span><span class="n">Jout</span> <span class="o">=</span> <span class="n">brute</span><span class="p">(</span><span class="n">fun</span><span class="p">,(</span><span class="nb">slice</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">f</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="mf">0.01</span><span class="p">),</span><span class="nb">slice</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">f</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="mf">0.01</span><span class="p">)),</span><span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filter: </span><span class="si">{</span><span class="nb">filter</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> Functional:</span><span class="si">{</span><span class="n">Z</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="se">\t</span><span class="s2"> Pump shift: </span><span class="si">{</span><span class="n">fA</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">MHz </span><span class="se">\t</span><span class="s2"> Exc/Ref shift: </span><span class="si">{</span><span class="n">fB</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">MHz&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fval</span><span class="p">,</span> <span class="n">fA</span><span class="p">,</span> <span class="n">fB</span><span class="p">,</span><span class="n">grid</span><span class="p">,</span><span class="n">Jout</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">optimise</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">]</span>
        <span class="n">best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
        <span class="n">funct</span><span class="p">,</span> <span class="n">fA</span><span class="p">,</span> <span class="n">fB</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best filter: </span><span class="si">{</span><span class="nb">filter</span><span class="p">[</span><span class="n">best</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">funct</span><span class="p">,</span> <span class="n">fA</span><span class="p">,</span> <span class="n">fB</span><span class="p">,</span><span class="n">grid</span><span class="p">,</span><span class="n">Jout</span> <span class="o">=</span> <span class="n">optimise</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filter: None Functional:</span><span class="si">{</span><span class="n">funct</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="se">\t</span><span class="s2"> Pump shift: </span><span class="si">{</span><span class="n">fA</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">MHz </span><span class="se">\t</span><span class="s2"> Exc/Ref shift: </span><span class="si">{</span><span class="n">fB</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">MHz&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">funct</span><span class="p">,</span> <span class="n">fA</span><span class="p">,</span> <span class="n">fB</span><span class="p">,</span><span class="n">grid</span><span class="p">,</span><span class="n">Jout</span>  <span class="o">=</span> <span class="n">optimise</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filter: </span><span class="si">{</span><span class="nb">filter</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> Functional:</span><span class="si">{</span><span class="n">funct</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="se">\t</span><span class="s2"> Pump shift: </span><span class="si">{</span><span class="n">fA</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">MHz </span><span class="se">\t</span><span class="s2"> Exc/Ref shift: </span><span class="si">{</span><span class="n">fB</span><span class="o">*</span><span class="mf">1e3</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">MHz&quot;</span><span class="p">)</span>

    <span class="n">new_pump_pulse</span> <span class="o">=</span> <span class="n">pump_pulse</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_pump_pulse</span> <span class="o">=</span> <span class="n">shift_pulse_freq</span><span class="p">(</span><span class="n">new_pump_pulse</span><span class="p">,</span><span class="n">fA</span><span class="p">)</span>
    <span class="n">new_exc_pulse</span> <span class="o">=</span> <span class="n">exc_pulse</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_exc_pulse</span> <span class="o">=</span> <span class="n">shift_pulse_freq</span><span class="p">(</span><span class="n">new_exc_pulse</span><span class="p">,</span><span class="n">fB</span><span class="p">)</span>

    <span class="n">new_ref_pulse</span> <span class="o">=</span> <span class="n">ref_pulse</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nDEER</span><span class="p">:</span>
        <span class="n">new_ref_pulse</span> <span class="o">=</span> <span class="n">shift_pulse_freq</span><span class="p">(</span><span class="n">new_ref_pulse</span><span class="p">,</span><span class="n">fB</span><span class="p">)</span>


    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_pump_pulse</span><span class="p">,</span> <span class="n">new_exc_pulse</span><span class="p">,</span> <span class="n">new_ref_pulse</span><span class="p">,</span> <span class="nb">filter</span><span class="p">[</span><span class="n">best</span><span class="p">],</span><span class="n">funct</span><span class="p">,</span><span class="n">grid</span><span class="p">,</span><span class="n">Jout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_pump_pulse</span><span class="p">,</span> <span class="n">new_exc_pulse</span><span class="p">,</span> <span class="n">new_ref_pulse</span><span class="p">,</span> <span class="nb">filter</span><span class="p">[</span><span class="n">best</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_pump_pulse</span><span class="p">,</span> <span class="n">new_exc_pulse</span><span class="p">,</span> <span class="n">new_ref_pulse</span><span class="p">,</span> <span class="n">funct</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">Jout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">new_pump_pulse</span><span class="p">,</span> <span class="n">new_exc_pulse</span><span class="p">,</span> <span class="n">new_ref_pulse</span><span class="p">,</span></div>



<div class="viewcode-block" id="plot_overlap">
<a class="viewcode-back" href="../../autoapi/autodeer/index.html#autodeer.DEER_analysis.plot_overlap">[docs]</a>
<span class="k">def</span> <span class="nf">plot_overlap</span><span class="p">(</span><span class="n">Fieldsweep</span><span class="p">,</span> <span class="n">pump_pulse</span><span class="p">,</span> <span class="n">exc_pulse</span><span class="p">,</span> <span class="n">ref_pulse</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">respro</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_ref_pulses</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots the pump and excitation profiles as well as the fieldsweep and filter profile.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    Fieldsweep : ad.FieldSweepAnalysis</span>
<span class="sd">        The FieldSweep analysis object</span>
<span class="sd">    pump_pulse : ad.Pulse</span>
<span class="sd">        The pump pulse object</span>
<span class="sd">    exc_pulse : ad.Pulse</span>
<span class="sd">        The excitation pulse object</span>
<span class="sd">    ref_pulse : ad.Pulse, optional </span>
<span class="sd">        The refocusing pulse object, by default None</span>
<span class="sd">    filter : str or number, optional</span>
<span class="sd">        The filter profile if applicable, by default None. If it is a number a filter is generated with this cutoff frequency.</span>
<span class="sd">        If the string &#39;Matched&#39; is used a matched filter is used.</span>
<span class="sd">    respro : ad.ResonatorProfileAnalysis, optional</span>
<span class="sd">        The resonator profile for fitting, by default None. The resonator profile must include the fit.</span>
<span class="sd">    num_ref_pulses : int, optional</span>
<span class="sd">        The total number of refocusing pulses, by default 2</span>
<span class="sd">    axs : matplotlib.axes, optional</span>
<span class="sd">        The axes to plot on, by default None</span>
<span class="sd">    fig : matplotlib.figure, optional</span>
<span class="sd">        The figure to plot on, by default None</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">gyro</span>  <span class="o">=</span> <span class="n">Fieldsweep</span><span class="o">.</span><span class="n">gyro</span>
    <span class="n">fieldsweep_fun</span> <span class="o">=</span> <span class="n">Fieldsweep</span><span class="o">.</span><span class="n">func_freq</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">fieldsweep_profile</span> <span class="o">=</span> <span class="n">fieldsweep_fun</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        
    <span class="n">pump_Mz</span> <span class="o">=</span> <span class="n">normalise_01</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">pump_pulse</span><span class="o">.</span><span class="n">exciteprofile</span><span class="p">(</span><span class="n">freqs</span><span class="o">=</span><span class="n">f</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    <span class="n">exc_Mz</span> <span class="o">=</span> <span class="n">normalise_01</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">exc_pulse</span><span class="o">.</span><span class="n">exciteprofile</span><span class="p">(</span><span class="n">freqs</span><span class="o">=</span><span class="n">f</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ref_pulse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_ref_pulses</span><span class="p">):</span>
            <span class="n">exc_Mz</span> <span class="o">*=</span> <span class="n">normalise_01</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">ref_pulse</span><span class="o">.</span><span class="n">exciteprofile</span><span class="p">(</span><span class="n">freqs</span><span class="o">=</span><span class="n">f</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
    

    <span class="k">if</span> <span class="nb">filter</span> <span class="o">==</span> <span class="s1">&#39;Matched&#39;</span><span class="p">:</span>
        <span class="c1"># Matched filter</span>
        <span class="n">filter_profile</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">f_new</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">f_new</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">exc_Mz</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
        <span class="n">filter_profile</span> <span class="o">=</span> <span class="n">build__lowpass_butter_filter</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{},</span><span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;hspace&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
                           <span class="p">)</span>
        
    <span class="c1"># Normalise the fieldsweep profile</span>
    <span class="n">fieldsweep_profile</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fieldsweep_profile</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    
    <span class="c1"># Plot the profiles</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="n">fieldsweep_profile</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Fieldsweep&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">f</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="n">pump_Mz</span><span class="o">*</span><span class="n">fieldsweep_profile</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Pump Profile&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#D95B6F&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">f</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="n">exc_Mz</span><span class="o">*</span><span class="n">fieldsweep_profile</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Observer Profile&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#42A399&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="n">filter_profile</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Filter&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">respro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_norm</span> <span class="o">=</span> <span class="n">respro</span><span class="o">.</span><span class="n">model</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">respro</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">axs</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">respro</span><span class="o">.</span><span class="n">model_x</span> <span class="o">-</span> <span class="n">Fieldsweep</span><span class="o">.</span><span class="n">LO</span><span class="p">)</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">model_norm</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Resonator Profile&#39;</span><span class="p">)</span>

    <span class="n">fmin</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fieldsweep_profile</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">fmax</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">fieldsweep_profile</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">fmin</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span><span class="n">fmax</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span>

    <span class="n">axs</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (MHz)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="calc_deer_settings">
<a class="viewcode-back" href="../../autoapi/autodeer/index.html#autodeer.DEER_analysis.calc_deer_settings">[docs]</a>
<span class="k">def</span> <span class="nf">calc_deer_settings</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">CPdecay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Refocused2D</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_time</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">target_MNR</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">waveform_precision</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the optimal DEER settings based on the avaliable relaxation data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    experiment : str</span>
<span class="sd">        Type of DEER experiment, either &#39;auto&#39;, &#39;4pDEER&#39; or &#39;5pDEER&#39;</span>
<span class="sd">    CPdecay : ad.CarrPurcellAnalysis</span>
<span class="sd">        Carr-Purcell relaxation data</span>
<span class="sd">    Refocused2D : ad.RefocusedEcho2DAnalysis, optional</span>
<span class="sd">        Refocused 2D data required for &#39;4pDEER&#39;, by default None</span>
<span class="sd">    target_time : int, optional</span>
<span class="sd">        Target time for the DEER experiment in hours, by default 2</span>
<span class="sd">    target_MNR : float, optional</span>
<span class="sd">        Target modulation to noise ratio, by default 20</span>
<span class="sd">    waveform_precision : int, optional</span>
<span class="sd">        Precision of the waveform in ns, by default 2</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        DEER settings, with keys: </span>
<span class="sd">            -&#39;ExpType&#39;: &#39;4pDEER&#39; or &#39;5pDEER&#39;</span>
<span class="sd">            -&#39;tau1&#39;: in us</span>
<span class="sd">            -&#39;tau2&#39;: in us</span>
<span class="sd">            -&#39;tau3&#39;: in us, only for 5pDEER</span>
<span class="sd">            -&#39;AimTime&#39;: in hours</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    This function will calcate the optimal DEER settings based on the avaliable relaxation data, depending on the experiment type.</span>
<span class="sd">    For 4pDEER, the optimal tau1 and tau2 are calculated based on the refocused 2D data, and for 5pDEER, the optimal tau2 is calculated based on the CPdecay data or refocused 2D if CP decay data is not availiable.</span>
<span class="sd">    If the optimal tau2 for 5pDEER is less than 1.5us, the function will calculate the optimal tau1 and tau2 for 4pDEER instead. This is only possible if the refocused 2D data is availiable, otherwise a non optimal tau1 of 0.4us is used.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Calculate the DEER settings from the avaliable relaxation data</span>
    <span class="c1"># Move out of the GUI Code asap</span>

    <span class="n">deer_settings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">experiment</span> <span class="o">==</span> <span class="s1">&#39;4pDEER&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Refocused2D</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Refocused2D data required for 4pDEER&quot;</span><span class="p">)</span>
        <span class="c1"># Calcualting a 4pDEER Sequence</span>
        <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;ExpType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;4pDEER&#39;</span>

        <span class="c1"># Calculate tau1 and tau2</span>
        <span class="n">tau1</span><span class="p">,</span><span class="n">tau2</span> <span class="o">=</span> <span class="n">Refocused2D</span><span class="o">.</span><span class="n">find_optimal</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;4pDEER&#39;</span><span class="p">,</span><span class="n">SNR_target</span><span class="o">=</span><span class="n">target_MNR</span><span class="p">,</span> <span class="n">target_time</span><span class="o">=</span><span class="n">target_time</span><span class="p">,</span> <span class="n">target_step</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">tau2</span> <span class="o">&lt;</span> <span class="mf">2.5</span><span class="p">:</span>
            <span class="c1"># 2hr dipolar evo too short for meaningful results. Using double the time instead</span>
            <span class="n">target_time</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="n">tau1</span><span class="p">,</span><span class="n">tau2</span> <span class="o">=</span> <span class="n">Refocused2D</span><span class="o">.</span><span class="n">find_optimal</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;4pDEER&#39;</span><span class="p">,</span><span class="n">SNR_target</span><span class="o">=</span><span class="n">target_MNR</span><span class="p">,</span> <span class="n">target_time</span><span class="o">=</span><span class="n">target_time</span><span class="p">,</span> <span class="n">target_step</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">tau2</span> <span class="o">&lt;</span> <span class="mf">2.5</span><span class="p">:</span>
            <span class="c1"># Dipolar evo time still too short. Hardcoding a 2.5us dipolar evo time</span>
            <span class="n">tau1</span><span class="p">,</span><span class="n">tau2</span> <span class="o">=</span> <span class="n">Refocused2D</span><span class="o">.</span><span class="n">optimal_tau1</span><span class="p">(</span><span class="n">tau2</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
        

        <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">round_step</span><span class="p">(</span><span class="n">tau1</span><span class="p">,</span><span class="n">waveform_precision</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
        <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;tau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">round_step</span><span class="p">(</span><span class="n">tau2</span><span class="p">,</span><span class="n">waveform_precision</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
        <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;AimTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_time</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">experiment</span> <span class="o">==</span> <span class="s1">&#39;5pDEER&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">experiment</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="c1"># Calculate a 5pDEER Sequence</span>
        <span class="k">if</span> <span class="n">CPdecay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tau2hrs</span> <span class="o">=</span> <span class="n">CPdecay</span><span class="o">.</span><span class="n">find_optimal</span><span class="p">(</span><span class="n">SNR_target</span><span class="o">=</span><span class="n">target_MNR</span><span class="p">,</span> <span class="n">target_time</span><span class="o">=</span><span class="n">target_time</span><span class="p">,</span> <span class="n">target_step</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
            <span class="n">tau4hrs</span> <span class="o">=</span> <span class="n">CPdecay</span><span class="o">.</span><span class="n">find_optimal</span><span class="p">(</span><span class="n">SNR_target</span><span class="o">=</span><span class="n">target_MNR</span><span class="p">,</span> <span class="n">target_time</span><span class="o">=</span><span class="n">target_time</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">target_step</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">Refocused2D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tau2hrs</span> <span class="o">=</span> <span class="n">Refocused2D</span><span class="o">.</span><span class="n">find_optimal</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;5pDEER&#39;</span><span class="p">,</span><span class="n">SNR_target</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">target_time</span><span class="o">=</span><span class="n">target_time</span><span class="p">,</span> <span class="n">target_step</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
            <span class="n">tau4hrs</span> <span class="o">=</span> <span class="n">Refocused2D</span><span class="o">.</span><span class="n">find_optimal</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;5pDEER&#39;</span><span class="p">,</span><span class="n">SNR_target</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">target_time</span><span class="o">=</span><span class="n">target_time</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">target_step</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CPdecay data required for 5pDEER&quot;</span><span class="p">)</span>

        
        <span class="k">if</span> <span class="p">(</span><span class="n">tau2hrs</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tau4hrs</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">):</span>
            <span class="c1"># 2hr dipolar evo too short for meaningful results. Using 4hr number instead</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">round_step</span><span class="p">(</span><span class="n">tau4hrs</span><span class="p">,</span><span class="n">waveform_precision</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;tau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">round_step</span><span class="p">(</span><span class="n">tau4hrs</span><span class="p">,</span><span class="n">waveform_precision</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;tau3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">round_step</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span><span class="n">waveform_precision</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;ExpType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;5pDEER&#39;</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;AimTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_time</span><span class="o">*</span><span class="mi">2</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">tau2hrs</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tau4hrs</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">):</span>
            <span class="c1"># 2hr &amp; 4hr dipolar evo too short for meaningful results. Hardcoding a 2.5us dipolar evo time, in 4pDEER and 4hrs</span>
            <span class="c1"># self.raise_warning(f&quot;2hr dipolar evo too short. Hardcoding a 2.5us dipolar evo time&quot;)</span>
            <span class="n">tau2</span> <span class="o">=</span> <span class="mf">2.5</span>
            <span class="k">if</span> <span class="n">Refocused2D</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tau1</span> <span class="o">=</span> <span class="n">Refocused2D</span><span class="o">.</span><span class="n">optimal_tau1</span><span class="p">(</span><span class="n">tau2</span><span class="o">=</span><span class="n">tau2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tau1</span> <span class="o">=</span> <span class="mf">0.4</span>

            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">round_step</span><span class="p">(</span><span class="n">tau1</span><span class="p">,</span><span class="n">waveform_precision</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;tau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">round_step</span><span class="p">(</span><span class="n">tau2</span><span class="p">,</span><span class="n">waveform_precision</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
            
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;ExpType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;4pDEER&#39;</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;AimTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_time</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="c1"># self.raise_warning(f&quot;2hr dipolar evo {tau2hrs:.2f} us, using 4pDEER&quot;)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Normal case, using 2hr dipolar evo time</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;tau1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">round_step</span><span class="p">(</span><span class="n">tau2hrs</span><span class="p">,</span><span class="n">waveform_precision</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;tau2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">round_step</span><span class="p">(</span><span class="n">tau2hrs</span><span class="p">,</span><span class="n">waveform_precision</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;tau3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">round_step</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span><span class="n">waveform_precision</span><span class="o">/</span><span class="mf">1e3</span><span class="p">)</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;ExpType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;5pDEER&#39;</span>
            <span class="n">deer_settings</span><span class="p">[</span><span class="s1">&#39;AimTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_time</span>

    <span class="k">return</span> <span class="n">deer_settings</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2021-2024, Hugo Karas, Gunnar Jeschke, Stefan Stoll
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=48f8e935"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    </body>
</html>